# Testing and Cleanup Guide

## Test Organization

Test files and scripts are located in the `/tests` directory:

```
tests/
├── README.md                    # Test documentation
├── run-tests.sh                 # Automated test execution script
├── cleanup.sh                   # Automated cleanup script for test PRs
├── pr-numbers.txt              # (Generated) PR numbers created by tests
├── single-file/                # Single file sending tests
│   └── sample.md
├── folder-structure/           # Folder structure tests
│   ├── src/
│   │   ├── index.js
│   │   └── utils.js
│   ├── config.json
│   └── README.md
└── edge-cases/                 # Edge case tests
    ├── deeply/
    │   └── nested/
    │       └── structure/
    │           └── file.txt
    ├── special-chars.txt
    ├── empty/
    └── README.md
```

## Running Tests

### Step 1: Prerequisites

```bash
# Install pr-cannon globally
npm install -g pr-cannon

# Set GitHub token
export GITHUB_TOKEN="ghp_your_token_here"

# Install GitHub CLI
# macOS: brew install gh
# Linux: Follow https://cli.github.com/
# Windows: Follow https://cli.github.com/
```

### Step 2: Run Tests

```bash
# Run against test repository
./tests/run-tests.sh is0692vs/test-pr-cannon

# Or use default: is0692vs/test-pr-cannon
./tests/run-tests.sh
```

**Output Example:**

```
🧪 PR Cannon Folder Sending Feature Test

Repository: is0692vs/test-pr-cannon
Test Directory: /path/to/tests

📝 Test 1: Single File Sending
Sending: /path/to/tests/single-file/sample.md
✅ PR #42 created

📁 Test 2: Folder Structure Sending
Sending: /path/to/tests/folder-structure
✅ PR #43 created

🔧 Test 3: Edge Cases (Nested Structure)
Sending: /path/to/tests/edge-cases
✅ PR #44 created

📊 Test Summary
Total PRs created: 3
PR Numbers: 42 43 44

✅ Tests completed!
💡 Run './tests/cleanup.sh' to close all test PRs
```

## Cleanup Process

### Manual Cleanup with GitHub CLI

If you need to manually close test PRs:

```bash
# Close a single PR
gh pr close 42 --repo is0692vs/test-pr-cannon --comment "✅ Test PR - Feature working correctly"

# Close multiple PRs
for pr in 42 43 44; do
  gh pr close $pr --repo is0692vs/test-pr-cannon
done
```

### Automated Cleanup

The `cleanup.sh` script automates the entire process:

```bash
./tests/cleanup.sh is0692vs/test-pr-cannon
```

**What it does:**

1. Reads `pr-numbers.txt` (created by `run-tests.sh`)
2. For each PR:
   - Adds a comment explaining it was an automated test for Issue #7
   - Closes the PR automatically
3. Cleans up temporary files

**Output Example:**

```
🧹 PR Cannon Test PR Cleanup

Repository: is0692vs/test-pr-cannon

Found PRs to close: 42 43 44

Closing PR #42...
✅ PR #42 closed

Closing PR #43...
✅ PR #43 closed

Closing PR #44...
✅ PR #44 closed

✅ Cleanup completed!
```

## PR Comment Template

When closing test PRs, the following comment is automatically added:

```
✅ **Test PR Closed**

This PR was created as part of the **Issue #7: Folder/Directory Sending Feature** testing.

- **Test Type:** [Single file | Folder structure | Edge cases]
- **Feature:** Folder/Directory sending capability for pr-cannon
- **Status:** Tested and verified ✓

This is an automated test PR and is now being closed.

---
*Generated by pr-cannon test cleanup script*
```

## Test Coverage

### Test 1: Single File Sending

- ✅ Send single `.md` file
- ✅ Verify file arrives in destination
- ✅ Check file integrity
- ✅ PR title and description correct

### Test 2: Folder Structure Sending

- ✅ Send multiple files in folder
- ✅ Preserve directory structure
- ✅ Maintain file relationships
- ✅ Correct relative paths

### Test 3: Edge Cases

- ✅ Deeply nested directories (3 levels)
- ✅ Special characters in filenames
- ✅ Empty directories (excluded)
- ✅ Hidden files (excluded)

## Troubleshooting

### "gh command not found"

Install GitHub CLI: https://cli.github.com/

### "GITHUB_TOKEN not found"

```bash
export GITHUB_TOKEN="ghp_your_token_here"
```

### "Repository not found"

- Verify repository exists
- Check you have access
- Ensure format: `owner/repo`

### "No pr-numbers.txt file found"

Run `./tests/run-tests.sh` first to create test PRs

## Continuous Integration

For automated testing in CI/CD pipelines:

```bash
#!/bin/bash
set -e

# Setup
npm install -g pr-cannon
export GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}

# Run tests
cd tests
./run-tests.sh owner/test-repo

# Wait for PRs to be created
sleep 5

# Cleanup
./cleanup.sh owner/test-repo
```

## Additional Notes

- Test PRs are created in a dedicated test repository to avoid clutter
- All test files are included in the git repository for reproducibility
- The `pr-numbers.txt` file is generated and ignored by git
- Test scripts are executable (chmod +x)
- Both bash scripts support custom repository via argument
